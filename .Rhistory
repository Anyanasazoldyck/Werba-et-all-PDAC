nExp.adj
best.pK <- as.numeric(as.vector(find.pK(sweep.stats)$pK[which.max(find.pK(sweep.stats)$BCmetric)]))
best.pK
sweep.stats
sample <- doubletFinder(sample,
PCs = 1:30,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = TRUE)
best.pK
sample <- doubletFinder(sample,
PCs = 1:30,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE)
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = 1:10,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE)
# Run DoubletFinder
sample <- doubletFinder(
sua = sample,
PCs = pcs_use,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
doubletFinder
?doubletFinder
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = pcs_use,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
pcs_use=1:10
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = pcs_use,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
stopifnot(is.numeric(pcs_use), all(pcs_use %% 1 == 0))
# 2) Make sure PCA embeddings are a MATRIX (not a data.frame)
sample@reductions$pca@cell.embeddings <- as.matrix(Embeddings(sample, "pca"))
stopifnot(is.matrix(Embeddings(sample, "pca")))
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = pcs_use,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
best.pK
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = pcs_use,
pN = 0.25,
pK =as.numeric  (best.pK),
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
# Run DoubletFinder
sample <- doubletFinder(sample,
PCs = as.numeric(pcs_use),
pN = 0.25,
pK =as.numeric  (best.pK),
nExp = nExp.adj,
reuse.pANN = FALSE,
sct = FALSE
)
nExp.adj
# Run DoubletFinder
sample <- doubletFinder(sample, PCs = 1:10, pN = 0.25, pK = 0.3, nExp = nExp.adj, reuse.pANN = NULL, sct = FALSE)
#---------------doublet finder per sample------------------------
#set a file dir
doublets_finder= file.path(plots,"doublets")
run_doubletfinder_lognorm <- function(
seu,
elbow_drop = 0.5,
target_cumvar = 90,
min_pc_floor = 5,
resolution = 0.1)
{
# Basic preprocessing
DefaultAssay(seu) <- "RNA"
seu <- NormalizeData(seu, verbose = FALSE)
seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seu <- ScaleData(seu, verbose = FALSE)
seu <- RunPCA(seu, verbose = FALSE)
# ---- chose PC "Squid Stat" ----
stdev <- seu@reductions$pca@stdev
percent_var <- (stdev^2 / sum(stdev^2)) * 100 #elbow plot values
cumulative_var <- cumsum(percent_var)
PC1 <- which(cumulative_var > target_cumvar)[1]
dvar <- diff(percent_var)
PC2 <- which(dvar < elbow_drop)[1] + 1
min_pc <- max(min_pc_floor, min(PC1, PC2))
min_pc= as.numeric(min_pc)
pcs_use <- 1:min_pc
#find seurat clusters
seu <- FindNeighbors(seu, dims = pcs_use, verbose = FALSE)
seu <- FindClusters(seu, resolution = resolution, verbose = FALSE)
# PK
sweep.res <- paramSweep(seu, PCs = pcs_use, sct = F)
sweep.stats <- summarizeSweep(sweep.res, GT = FALSE)
best.pK <- as.numeric(as.vector(find.pK(sweep.stats)$pK[which.max(find.pK(sweep.stats)$BCmetric)]))
# ---- Estimate multiplet rate from 10x lookup table ----
print(">> Estimating multiplet rate from 10x table...")
multiplet_rates_10x <- data.frame( 'Multiplet_rate'= c(0.004, 0.008, 0.0160, 0.023, 0.031, 0.039, 0.046, 0.054, 0.061, 0.069, 0.076),
'Loaded_cells' = c(800, 1600, 3200, 4800, 6400, 8000, 9600, 11200, 12800, 14400, 16000),
'Recovered_cells' = c(500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000) )
multiplet_rate <- multiplet_rates_10x %>% dplyr::filter(Recovered_cells < nrow(seu@meta.data)) %>%
dplyr::slice(which.max(Recovered_cells)) %>%
dplyr::select(Multiplet_rate) %>%
as.numeric(as.character())
# ---- Homotypic adjustment ----
annotations <- seu@meta.data$seurat_clusters
# use the clusters as the user-defined cell types
homotypic.prop <- modelHomotypic(annotations)
nExp.poi <- round(multiplet_rate * nrow(seu@meta.data)) # multiply by number of cells to get the number of expected multiplets
nExp.adj <- round(nExp.poi * (1 - homotypic.prop)) # expected number of doublets
# ---- Run DoubletFinder ----
print(">> Running DoubletFinder...")
seu <- DoubletFinder::doubletFinder(
seu = seu,
PCs = pcs_use,
pN = 0.25,
pK = best.pK,
nExp = nExp.adj,
sct = FALSE
)
df.col <- grep("^DF.classification", colnames(seu@meta.data), value = TRUE)[1]
seu <- subset(seu, cells = colnames(seu)[seu@meta.data[[df.col]] == "Singlet"])
# Return results + parameters for audit
list(seu)
}
objectsseurat_list_no_liver <- readRDS("D:/PDAC_SCRNA/objects/objectsseurat_list_no_liver.rds")
#install doublet finder
remotes::install_github('chris-mcginnis-ucsf/DoubletFinder', force = TRUE)
library(DoubletFinder)
dim(seu)
seu=objectsseurat_list_no_liver$P03
dim(seu)
length(colnames(seu))
library(seurat)
seu=objectsseurat_list_no_liver$P03
View(seu)
View(seu@meta.data)
seu <- NormalizeData(seu, verbose = FALSE)
library(seurat)
library(seurat)
library(Seurat)
seu <- NormalizeData(seu, verbose = FALSE)
seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seu <- ScaleData(seu, verbose = FALSE)
seu <- RunPCA(seu, verbose = FALSE)
library(Seurat)
library(DoubletFinder)
seu=objectsseurat_list_no_liver$P03
View(seu)
View(seu@meta.data)
# ---- chose PC "Squid Stat" ----
ElbowPlot(seu)
seu <- RunPCA(seu, verbose = FALSE)
library(Seurat)
#install doublet finder
#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder', force = TRUE)
library(DoubletFinder)
seu=objectsseurat_list_no_liver$P03
View(seu)
View(seu@meta.data)
#filter low quality cells
seu[["percent.mt"]]= PercentageFeatureSet(seu, pattern = "^MT")
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
View(seu)
seu=objectsseurat_list_no_liver$P03
View(seu)
View(seu@meta.data)
#filter low quality cells
seu[["percent.mt"]]= PercentageFeatureSet(seu, pattern = "^MT")
seu=objectsseurat_list_no_liver$P03
#filter low quality cells
seu[["percent.mt"]]= PercentageFeatureSet(seu, pattern = "^MT")
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
FeatureScatter(seu, feature1 ="nCount_RNA", feature2 = "nFeature_RNA" )
seu=subset(seu, nFeature_RNA >500 & nCount_RNA >500 , percent.mt <15)
seu=subset(seu, nFeature_RNA >500 & nCount_RNA >500 & percent.mt <15)
library(Seurat)
#install doublet finder
#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder', force = TRUE)
library(DoubletFinder)
seu=objectsseurat_list_no_liver$P03
View(seu)
View(seu@meta.data)
#filter low quality cells
seu[["percent.mt"]] = PercentageFeatureSet(seu, pattern = "^MT")
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(seu, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
seu= subset(seu, nFeature_RNA >500 & nCount_RNA >1500 & percent.mt <15)
#normalize
seu <- NormalizeData(seu, verbose = FALSE)
seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seu <- ScaleData(seu, verbose = FALSE)
seu <- RunPCA(seu, verbose = FALSE)
seu <- NormalizeData(seu, verbose = FALSE)
seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seu <- ScaleData(seu, verbose = FALSE)
seu <- RunPCA(seu, verbose = FALSE)
# ---- chose PC "Squid Stat" ----
ElbowPlot(seu)
pcs_use=1:10
#find seurat clusters
seu <- FindNeighbors(seu, dims = pcs_use, verbose = FALSE)
seu <- FindClusters(seu, resolution = 0.5, verbose = FALSE)
seu < RunUMAP(seu,dims = pcs_use, spread = 8, min.dist = 0.2 )
View(seu)
DimPlot(seu, reduction = "umap")
seu < RunUMAP(seu,dims = pcs_use, spread = 8, min.dist = 0.2 , reduction.name = "umap")
View(seu)
DimPlot(seu, reduction = "umap")
seu <- RunPCA(seu, verbose = FALSE)
pcs_use=1:10
seu <- RunPCA(seu, verbose = FALSE)
ElbowPlot(seu)
pcs_use=1:10
# ---- chose PC "Squid Stat" ----
ElbowPlot(seu)
View(seu)
View(seu@meta.data)
seu < RunUMAP(seu, spread = 8, min.dist = 0.2 , reduction.name = "umap")
seu < RunUMAP(seu, spread = 8, min.dist = 0.2 , reduction.name = "umap", dims = pcs_use)
seu <- NormalizeData(seu, verbose = FALSE)
seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seu <- ScaleData(seu, verbose = FALSE)
seu <- RunPCA(seu, verbose = FALSE)
ElbowPlot(seu)
pcs_use=1:10
# ---- chose PC "Squid Stat" ----
ElbowPlot(seu)
#find seurat clusters
seu <- FindNeighbors(seu, dims = pcs_use, verbose = FALSE)
seu <- FindClusters(seu, resolution = 0.5, verbose = FALSE)
View(seu)
View(seu@meta.data)
seu <- RunUMAP(seu, dims =pcs_use, spread = 8, min.dist = 0.2)
View(seu)
DimPlot(seu, reduction = "umap", pt.size = 0.5)
seu <- FindClusters(seu, resolution = 0.2, verbose = FALSE)
seu <- RunUMAP(seu, dims =pcs_use, spread = 8, min.dist = 0.2)
DimPlot(seu, reduction = "umap", pt.size = 0.5)
# PK
sweep.res <- paramSweep(seu, PCs = pcs_use, sct = F)
sweep.stats <- summarizeSweep(sweep.res, GT = FALSE)
View(sweep.stats)
best.pk <- as.numeric(find.pK(sweep.stats))
best.pk <- find.pK(sweep.stats)
best.pk
best.pk <- find.pK(sweep.stats)
View(best.pk)
?find.pK
library(ggplot2)
ggplot(best.pk, aes(x = as.numeric(as.character(pK)),
y = BCmetric)) +
geom_point() + geom_line() +
xlab("pK (neighborhood size)") +
ylab("BCmetric (bimodality)") +
theme_minimal()
ggplot(best.pk, aes(x = as.numeric(as.character(pK)),
y = BCmetric)) +
geom_point() +
xlab("pK") +
ylab("BCmetric") +
theme_minimal()
sweep.stats <- summarizeSweep(sweep.res, GT = FALSE)
View(sweep.stats)
best.pk <- find.pK(sweep.stats, )
best.pk <- find.pK(sweep.stats )
best.pk <- find.pK(sweep.stats )
best.pk
View(best.pk)
best.pk <- find.pK(sweep.stats )
ggplot2::ggplot(best.pk, aes(x=pk, y=BCmetric))+
geom_point()+geom_line()
ggplot2::ggplot(best.pk, aes(x=pK, y=BCmetric))+
geom_point()+geom_line()
my_best_pk= best.pk$pK[which.max(best.pk$BCmetric)]
my_best_pk
best.pK <- as.numeric(as.character(best.pK))
my_best_pk <- as.numeric(as.character(my_best_pk))
View(best.pk)
best.pk <- find.pK(sweep.stats )
ggplot(best.pk, aes(x=pK, y=BCmetric))+
geom_line()
ggplot(best.pk, aes(x=pK, y=BCmetric))+
geom_point()+
geom_line()
my_best_pk= 0.15
#estimate the multiplate rate
length(colnames(seu))
View(seu)
meow= objectsseurat_list_no_liver$P03
length(colnames(meow))
rm(meow)
multiplet_rates_10x <- data.frame( 'Multiplet_rate'= c(0.004, 0.008, 0.0160, 0.023, 0.031, 0.039, 0.046, 0.054, 0.061, 0.069, 0.076),
'Loaded_cells' = c(800, 1600, 3200, 4800, 6400, 8000, 9600, 11200, 12800, 14400, 16000),
'Recovered_cells' = c(500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000) )
multiplet_rate <- multiplet_rates_10x %>% dplyr::filter(Recovered_cells < nrow(seu@meta.data)) %>%
dplyr::slice(which.max(Recovered_cells)) %>%
dplyr::select(Multiplet_rate) %>%
as.numeric(as.character())
multiplet_rate=
library(dplyr)
multiplet_rates_10x <- data.frame( 'Multiplet_rate'= c(0.004, 0.008, 0.0160, 0.023, 0.031, 0.039, 0.046, 0.054, 0.061, 0.069, 0.076),
'Loaded_cells' = c(800, 1600, 3200, 4800, 6400, 8000, 9600, 11200, 12800, 14400, 16000),
'Recovered_cells' = c(500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000) )
multiplet_rate <- multiplet_rates_10x %>% dplyr::filter(Recovered_cells < nrow(seu@meta.data)) %>%
dplyr::slice(which.max(Recovered_cells)) %>%
dplyr::select(Multiplet_rate) %>%
as.numeric(as.character())
#estimate the multiplate rate
length(colnames(seu))
multiplet_rate= 0.08
nExp.poi <- round(multiplet_rate * nrow(seu@meta.data)) # multiply by number of cells to get the number of expected multiplets
# ---- Homotypic adjustment ----
annotations <- seu@meta.data$seurat_clusters
homotypic.prop <- modelHomotypic(annotations)
nExp.adj <- round(nExp.poi * (1 - homotypic.prop)) # expected number of doublets
seu <- DoubletFinder::doubletFinder(
seu = seu,
PCs = pcs_use,
pN = 0.25,
pK = my_best_pk,
nExp = nExp.adj,
sct = FALSE
)
View(seu)
View(seu@meta.data)
meta_unfiltered = seu@meta.data
seu <- subset(seu, cells = colnames(seu)[seu@meta.data[["DF.classifications_0.25_0.15_1145"]] == "Singlet"])
View(seu)
View(seu@meta.data)
#------------post integration processing -------------
all_samples_integrated <- readRDS("D:/PDAC_SCRNA/objects/all_samples_integrated.rds")
library(ggplot2)
library(Seurat)
library(readxl)
library(stringr)
#find markers for each cluster
DefaultAssay(all_samples_integrated) <- "RNA"
DefaultAssay(all_samples_integrated) <- "integrated"
all_samples_integrated <- ScaleData(all_samples_integrated)
all_samples_integrated <- RunPCA(all_samples_integrated)
all_samples_integrated <- FindNeighbors(all_samples_integrated, dims = 1:5)
all_samples_integrated <- FindClusters(all_samples_integrated, resolution = 0.5)
p1= DimPlot(all_samples_integrated, reduction = "umap",group.by = "integrated_snn_res.0.5")
all_samples_integrated <- RunUMAP(all_samples_integrated, dims = 1:5)
p1= DimPlot(all_samples_integrated, reduction = "umap",group.by = "integrated_snn_res.0.5")
p1
all_samples_integrated <- FindClusters(all_samples_integrated, resolution = 0.3)
all_samples_integrated <- FindClusters(all_samples_integrated, resolution = 0.2)
all_samples_integrated <- RunUMAP(all_samples_integrated, dims = 1:5)
p1= DimPlot(all_samples_integrated, reduction = "umap",group.by = "integrated_snn_res.0.5")
p1
p1= DimPlot(all_samples_integrated, reduction = "umap",group.by = "integrated_snn_res.0.2")
p1
p1= DimPlot(all_samples_integrated, reduction = "umap",group.by = "integrated_snn_res.0.2")
p2= DimPlot(all_samples_integrated, reduction = "umap", group.by = "orig.ident")
png("plots/integrated_umap_res_02.png", res = 300, width = 300*10, height = 300*5)
p1+p2
dev.off()
png("plots/integrated_umap_Treatment.png", res = 300, width = 300*5, height = 300*5)
DimPlot(all_samples_integrated, reduction = "umap",group.by = "Treatment")
dev.off()
#find markers for each cluster
DefaultAssay(all_samples_integrated) <- "RNA"
markers <- FindAllMarkers(all_samples_integrated,only.pos = T)
View(all_samples_integrated)
?JoinLayers
all_samples_integrated <- JoinLayers(all_samples_integrated, assay = "RNA")
markers <- FindAllMarkers(all_samples_integrated,only.pos = T)
saveRDS(all_samples_integrated,"all_samples_integrated_dim_reduction.rds")
dir.create("csv", recursive = T)
write.csv(markers,"csv/cluster_markers.csv")
#filter markers
markers.sig <- markers[,"p_val_adj"<0.05 & "avg_log2FC">1]
topn=markers %>% dplyr::group_by(cluster) %>%
dplyr::arrange(desc(avg_log2FC), .by_group = T) %>% dplyr::slice_head(n=5)
topn
View(all_samples_integrated)
p=DoHeatmap(all_samples_integrated, features = topn$gene)
png("plots/heatmap.png", res = 300, width = 300*8, height = 300*8)
p
pdev.off()
dev.off()
#make a complex hm
?FetchData
hm_mtx <- FetchData(all_samples_integrated,vars = c(topn$gene, seurat_clusters) )
hm_mtx <- FetchData(all_samples_integrated,vars = c(topn$gene, "seurat_clusters") )
meta <- all_samples_integrated@meta.data
head(meta)
?merge
hm_mtx <- merge(x=hm_mtx,y=meta, by= intersect(rownames(hm_mtx), rownames(meta)))
hm_mtx <- merge(x=hm_mtx,y=meta, by= rownames(hm_mtx), rownames(meta))
hm_mtx <- merge(x=hm_mtx,y=meta, by.x= 0, by.y=0)
library(tidyr)
genes <- unique(topn$gene)
# 1) Fetch expression for genes + cluster + cell IDs
df <- FetchData(all_samples_integrated, vars = genes)
df$seurat_clusters <- Idents(all_samples_integrated)
df$cell <- colnames(all_samples_integrated)
# 2) Long format: one row per (cell, gene)
df_long <- df %>%
pivot_longer(
cols = all_of(genes),
names_to = "gene",
values_to = "expr"
)
# 3) Average per cluster × gene, then to wide matrix
avg <- df_long %>%
group_by(seurat_clusters, gene) %>%
summarise(expr = mean(expr, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(names_from = seurat_clusters, values_from = expr) %>%
data.frame(row.names = .$gene) %>% select(-gene)
# 3) Average per cluster × gene, then to wide matrix
avg <- df_long %>%
group_by(seurat_clusters, gene) %>%
summarise(expr = mean(expr, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(names_from = seurat_clusters, values_from = expr) %>%
data.frame(row.names = .$gene) %>% dplyr:: select(-gene)
# 3) Average per cluster × gene, then to wide matrix
avg <- df_long %>%
group_by(seurat_clusters, gene) %>%
dplyr::summarise(expr = mean(expr, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(names_from = seurat_clusters, values_from = expr) %>%
data.frame(row.names = .$gene) %>% dplyr:: select(-gene)
# 3) Average per cluster × gene, then to wide matrix
avg <- df_long %>%
dplyr::group_by(seurat_clusters, gene) %>%
dplyr::summarise(expr = mean(expr, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(names_from = seurat_clusters, values_from = expr) %>%
data.frame(row.names = .$gene) %>% dplyr:: select(-gene)
# 4) Scale rows and plot
mat <- t(scale(t(as.matrix(avg))))
mat[is.na(mat)] <- 0
row_split <- topn %>%
distinct(gene, cluster) %>%
right_join(tibble(gene = rownames(mat)), by = "gene") %>%
pull(cluster)
Heatmap(mat, name = "Z-score", row_split = row_split,
cluster_rows = TRUE, cluster_columns = TRUE,
show_row_names = TRUE, show_column_names = TRUE)
BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)
Heatmap(mat, name = "Z-score", row_split = row_split,
cluster_rows = TRUE, cluster_columns = TRUE,
show_row_names = TRUE, show_column_names = TRUE)
Heatmap(mat, name = "Z-score",
cluster_rows = TRUE, cluster_columns = TRUE,
show_row_names = TRUE, show_column_names = TRUE)
p=Heatmap(mat, name = "Z-score",
cluster_rows = F, cluster_columns = TRUE,
show_row_names = TRUE, show_column_names = TRUE)
p=Heatmap(mat, name = "Z-score",
cluster_rows = F, cluster_columns = TRUE,
show_row_names = TRUE, show_column_names = TRUE)
png("plots/complexheatmap.png", res = 300, width = 300*8, height = 300*8)
p
dev.off()
p=Heatmap(mat, name = "Z-score",
cluster_rows = T, cluster_columns = F,
show_row_names = TRUE, show_column_names = TRUE)
png("plots/complexheatmap.png", res = 300, width = 300*8, height = 300*8)
p
dev.off()
png("plots/complexheatmap.png", res = 300, width = 300*8, height = 300*10)
p
dev.off()
?RColorBrewer
display.brewer.pal(n, name)
display.brewer.all(n=NULL, type="all", select=NULL, exact.n=TRUE,
colorblindFriendly=T)
RColorBrewer::display.brewer.all(colorblindFriendly = T)
hm_palette = RColorBrewer::brewer.pal("RdYIBu", n=11)
hm_palette = RColorBrewer::brewer.pal(name="RdYlBu", n=11)
hm_palette
p=Heatmap(mat, name = "Z-score",
cluster_rows = T, cluster_columns = F,
show_row_names = TRUE, show_column_names = TRUE, color_space = hm_palette)
png("plots/complexheatmap.png", res = 300, width = 300*8, height = 300*10)
p
dev.off()
